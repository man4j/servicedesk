Raphael.fn.freeTransform=function(e,k,h){if(e.freeTransform){return e.freeTransform}if(!Array.prototype.hasOwnProperty("map")){Array.prototype.map=function(o,l){var n,m=[];for(n in this){if(this.hasOwnProperty(n)){m[n]=o.call(l,this[n],n,this)
}}return m}}if(!Array.prototype.hasOwnProperty("indexOf")){Array.prototype.indexOf=function(n,o){for(var m=(o||0),l=this.length;m<l;m++){if(this[m]===n){return m}}return -1}}var a=this,i=e.getBBox(true);
var c=e.freeTransform={attrs:{x:i.x,y:i.y,size:{x:i.width,y:i.height},center:{x:i.x+i.width/2,y:i.y+i.height/2},rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},axes:null,bbox:null,callback:null,items:[],handles:{center:null,x:null,y:null},offset:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},opts:{animate:false,attrs:{fill:"#fff",stroke:"#000"},boundary:{x:a._left||0,y:a._top||0,width:a.width,height:a.height},distance:1.3,drag:true,draw:false,keepRatio:false,range:{rotate:[-180,180],scale:[0,99999]},rotate:true,scale:true,snap:{rotate:0,scale:0,drag:0},snapDist:{rotate:0,scale:0,drag:7},size:5},subject:e};
c.updateHandles=function(){if(c.handles.bbox||c.opts.rotate.indexOf("self")>=0){var n=j()}var m={x:(c.attrs.rotate)*Math.PI/180,y:(c.attrs.rotate+90)*Math.PI/180};var l={x:c.attrs.size.x/2*c.attrs.scale.x,y:c.attrs.size.y/2*c.attrs.scale.y};
c.axes.map(function(q){if(c.handles[q]){var p=c.attrs.center.x+c.attrs.translate.x+l[q]*c.opts.distance*Math.cos(m[q]),r=c.attrs.center.y+c.attrs.translate.y+l[q]*c.opts.distance*Math.sin(m[q]);if(c.opts.boundary){p=Math.max(Math.min(p,c.opts.boundary.x+c.opts.boundary.width),c.opts.boundary.x);
r=Math.max(Math.min(r,c.opts.boundary.y+c.opts.boundary.height),c.opts.boundary.y)}c.handles[q].disc.attr({cx:p,cy:r});c.handles[q].line.toFront().attr({path:[["M",c.attrs.center.x+c.attrs.translate.x,c.attrs.center.y+c.attrs.translate.y],["L",c.handles[q].disc.attrs.cx,c.handles[q].disc.attrs.cy]]});
c.handles[q].disc.toFront()}});if(c.bbox){c.bbox.toFront().attr({path:[["M",n[0].x,n[0].y],["L",n[1].x,n[1].y],["L",n[2].x,n[2].y],["L",n[3].x,n[3].y],["L",n[0].x,n[0].y]]});var o=[[-1,-1],[1,-1],[1,1],[-1,1],[0,-1],[1,0],[0,1],[-1,0]];
if(c.handles.bbox){c.handles.bbox.map(function(t,s){var p,u,r,q;if(s<4){p=n[s].x;u=n[s].y}else{r=s%4;q=(r+1)%n.length;p=(n[r].x+n[q].x)/2;u=(n[r].y+n[q].y)/2}t.element.toFront().attr({x:p-c.opts.size,y:u-c.opts.size}).transform("R"+c.attrs.rotate);
t.x=o[s][0];t.y=o[s][1]})}}if(c.circle){c.circle.attr({cx:c.attrs.center.x+c.attrs.translate.x,cy:c.attrs.center.y+c.attrs.translate.y,r:Math.max(l.x,l.y)*c.opts.distance})}if(c.handles.center){c.handles.center.disc.toFront().attr({cx:c.attrs.center.x+c.attrs.translate.x,cy:c.attrs.center.y+c.attrs.translate.y})
}if(c.opts.rotate.indexOf("self")>=0){l=Math.max(Math.sqrt(Math.pow(n[1].x-n[0].x,2)+Math.pow(n[1].y-n[0].y,2)),Math.sqrt(Math.pow(n[2].x-n[1].x,2)+Math.pow(n[2].y-n[1].y,2)))/2}};c.showHandles=function(){c.hideHandles();
c.axes.map(function(p){c.handles[p]={};c.handles[p].line=a.path(["M",c.attrs.center.x,c.attrs.center.y]).attr({stroke:c.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.5});c.handles[p].disc=a.circle(c.attrs.center.x,c.attrs.center.y,c.opts.size).attr(c.opts.attrs)
});if(c.opts.draw.indexOf("bbox")>=0){c.bbox=a.path("").attr({stroke:c.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.5});c.handles.bbox=[];var n;for(n=(c.opts.scale.indexOf("bboxCorners")>=0?0:4);
n<(c.opts.keepRatio||c.opts.scale.indexOf("bboxSides")===-1?4:8);n++){c.handles.bbox[n]={};c.handles.bbox[n].element=a.rect(c.attrs.center.x,c.attrs.center.y,c.opts.size*2,c.opts.size*2).attr(c.opts.attrs)
}}if(c.opts.draw.indexOf("circle")>=0){c.circle=a.circle(0,0,0).attr({stroke:c.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.3})}if(c.opts.drag.indexOf("center")>=0){c.handles.center={};c.handles.center.disc=a.circle(c.attrs.center.x,c.attrs.center.y,c.opts.size).attr(c.opts.attrs)
}c.axes.map(function(q){if(!c.handles[q]){return}var p=c.opts.rotate.indexOf("axis"+q.toUpperCase())>=0,r=c.opts.scale.indexOf("axis"+q.toUpperCase())>=0;c.handles[q].disc.drag(function(w,v){if(c.o.viewBoxRatio){w*=c.o.viewBoxRatio.x;
v*=c.o.viewBoxRatio.y}var u=w+c.handles[q].disc.ox,y=v+c.handles[q].disc.oy;var x={x:c.o.scale.x<0,y:c.o.scale.y<0};if(p){var t=Math.atan2(y-c.o.center.y-c.o.translate.y,u-c.o.center.x-c.o.translate.x);
c.attrs.rotate=t*180/Math.PI-(q==="y"?90:0);if(x[q]){c.attrs.rotate-=180}}if(c.opts.boundary){u=Math.max(Math.min(u,c.opts.boundary.x+c.opts.boundary.width),c.opts.boundary.x);y=Math.max(Math.min(y,c.opts.boundary.y+c.opts.boundary.height),c.opts.boundary.y)
}var s=Math.sqrt(Math.pow(u-c.o.center.x-c.o.translate.x,2)+Math.pow(y-c.o.center.y-c.o.translate.y,2));if(r){if(c.opts.keepRatio){c.attrs.scale={x:s/(c.o.size[q]/2*c.opts.distance),y:s/(c.o.size[q]/2*c.opts.distance)}
}else{c.attrs.scale={x:q==="x"?s/(c.o.size.x/2*c.opts.distance):c.o.scale.x,y:q==="y"?s/(c.o.size.y/2*c.opts.distance):c.o.scale.y}}if(x[q]){c.attrs.scale[q]*=-1}}d();if(c.attrs.scale.x&&c.attrs.scale.y){c.apply()
}f([p?"rotate":null,r?"scale":null])},function(){c.o=b(c.attrs);if(a._viewBox){c.o.viewBoxRatio={x:a._viewBox[2]/a.width,y:a._viewBox[3]/a.height}}c.handles[q].disc.ox=this.attrs.cx;c.handles[q].disc.oy=this.attrs.cy;
f([p?"rotate start":null,r?"scale start":null])},function(){f([p?"rotate end":null,r?"scale end":null])})});if(c.opts.draw.indexOf("bbox")>=0&&(c.opts.scale.indexOf("bboxCorners")>=0||c.opts.scale.indexOf("bboxSides")>=0)){c.handles.bbox.map(function(p){p.element.drag(function(B,A){var r,q,w,u,y,x,v,t;
var s=c.o.rotate.sin,z=c.o.rotate.cos;if(c.o.viewBoxRatio){B*=c.o.viewBoxRatio.x;A*=c.o.viewBoxRatio.y}r=B*z-A*s;q=B*s+A*z;if(c.opts.keepRatio){r=q*(p.x*p.y<0?-1:1)}r*=Math.abs(p.x);q*=Math.abs(p.y);w=r*z+q*s;
u=r*-s+q*z;c.attrs.translate={x:c.o.translate.x+w/2,y:c.o.translate.y+u/2};y=c.o.handlePos.cx+B-c.attrs.center.x-c.attrs.translate.x;x=c.o.handlePos.cy+A-c.attrs.center.y-c.attrs.translate.y;r=y*z-x*s;
q=y*s+x*z;v=r*2*p.x/c.o.size.x;t=q*2*p.y/c.o.size.y;c.attrs.scale={x:v||c.o.scale.x,y:t||c.o.scale.y};d();c.apply();f(["scale"])},function(){var q=((360-c.attrs.rotate)%360)/180*Math.PI,r=p.element.attr(["x","y"]);
c.o=b(c.attrs);c.o.handlePos={cx:r.x+c.opts.size,cy:r.y+c.opts.size};c.o.rotate={sin:Math.sin(q),cos:Math.cos(q)};if(a._viewBox){c.o.viewBoxRatio={x:a._viewBox[2]/a.width,y:a._viewBox[3]/a.height}}f(["scale start"])
},function(){f(["scale end"])})})}var l=[];if(c.opts.drag.indexOf("self")>=0&&c.opts.scale.indexOf("self")===-1&&c.opts.rotate.indexOf("self")===-1){l.push(e)}if(c.opts.drag.indexOf("center")>=0){l.push(c.handles.center.disc)
}l.map(function(p){p.drag(function(r,q){if(c.o.viewBoxRatio){r*=c.o.viewBoxRatio.x;q*=c.o.viewBoxRatio.y}c.attrs.translate.x=c.o.translate.x+r;c.attrs.translate.y=c.o.translate.y+q;var s=b(c.o.bbox);s.x+=r;
s.y+=q;d(s);c.apply();f(["drag"])},function(){c.o=b(c.attrs);if(c.opts.snap.drag){c.o.bbox=e.getBBox()}if(a._viewBox){c.o.viewBoxRatio={x:a._viewBox[2]/a.width,y:a._viewBox[3]/a.height}}c.axes.map(function(q){if(c.handles[q]){c.handles[q].disc.ox=c.handles[q].disc.attrs.cx;
c.handles[q].disc.oy=c.handles[q].disc.attrs.cy}});f(["drag start"])},function(){f(["drag end"])})});var m=c.opts.rotate.indexOf("self")>=0,o=c.opts.scale.indexOf("self")>=0;if(m||o){e.drag(function(t,s,r,v){if(m){var q=Math.atan2(v-c.o.center.y-c.o.translate.y,r-c.o.center.x-c.o.translate.x);
c.attrs.rotate=c.o.rotate+(q*180/Math.PI)-c.o.deg}var u={x:c.o.scale.x<0,y:c.o.scale.y<0};if(o){var p=Math.sqrt(Math.pow(r-c.o.center.x-c.o.translate.x,2)+Math.pow(v-c.o.center.y-c.o.translate.y,2));c.attrs.scale.x=c.attrs.scale.y=(u.x?-1:1)*c.o.scale.x+(p-c.o.radius)/(c.o.size.x/2);
if(u.x){c.attrs.scale.x*=-1}if(u.y){c.attrs.scale.y*=-1}}d();c.apply();f([m?"rotate":null,o?"scale":null])},function(p,q){c.o=b(c.attrs);c.o.deg=Math.atan2(q-c.o.center.y-c.o.translate.y,p-c.o.center.x-c.o.translate.x)*180/Math.PI;
c.o.radius=Math.sqrt(Math.pow(p-c.o.center.x-c.o.translate.x,2)+Math.pow(q-c.o.center.y-c.o.translate.y,2));if(a._viewBox){c.o.viewBoxRatio={x:a._viewBox[2]/a.width,y:a._viewBox[3]/a.height}}f([m?"rotate start":null,o?"scale start":null])
},function(){f([m?"rotate end":null,o?"scale end":null])})}c.updateHandles()};c.hideHandles=function(){c.items.map(function(l){l.el.undrag()});if(c.handles.center){c.handles.center.disc.remove();c.handles.center=null
}["x","y"].map(function(l){if(c.handles[l]){c.handles[l].disc.remove();c.handles[l].line.remove();c.handles[l]=null}});if(c.bbox){c.bbox.remove();c.bbox=null;if(c.handles.bbox){c.handles.bbox.map(function(l){l.element.remove()
});c.handles.bbox=null}}if(c.circle){c.circle.remove();c.circle=null}};c.setOpts=function(m,o){c.callback=typeof o==="function"?o:false;var n,l;for(n in m){if(m[n]&&m[n].constructor===Object){for(l in m[n]){if(m[n].hasOwnProperty(l)){c.opts[n][l]=m[n][l]
}}}else{c.opts[n]=m[n]}}if(c.opts.animate===true){c.opts.animate={delay:700,easing:"linear"}}if(c.opts.drag===true){c.opts.drag=["center","self"]}if(c.opts.rotate===true){c.opts.rotate=["axisX","axisY"]
}if(c.opts.scale===true){c.opts.scale=["axisX","axisY","bboxCorners","bboxSides"]}["drag","draw","rotate","scale"].map(function(p){if(c.opts[p]===false){c.opts[p]=[]}});if(!c.opts.scale){c.opts.keepRatio=true
}c.axes=[];if(c.opts.rotate.indexOf("axisX")>=0||c.opts.scale.indexOf("axisX")>=0){c.axes.push("x")}if(c.opts.rotate.indexOf("axisY")>=0||c.opts.scale.indexOf("axisY")>=0){c.axes.push("y")}["drag","rotate","scale"].map(function(p){if(!c.opts.snapDist[p]){c.opts.snapDist[p]=c.opts.snap[p]
}});c.opts.range={rotate:[parseFloat(c.opts.range.rotate[0]),parseFloat(c.opts.range.rotate[1])],scale:[parseFloat(c.opts.range.scale[0]),parseFloat(c.opts.range.scale[1])]};c.opts.snap={drag:parseFloat(c.opts.snap.drag),rotate:parseFloat(c.opts.snap.rotate),scale:parseFloat(c.opts.snap.scale)};
c.opts.snapDist={drag:parseFloat(c.opts.snapDist.drag),rotate:parseFloat(c.opts.snapDist.rotate),scale:parseFloat(c.opts.snapDist.scale)};c.opts.size=parseInt(c.opts.size);c.showHandles();f(["init"])};
c.setOpts(k,h);c.apply=function(){c.items.map(function(o,n){var l={x:c.attrs.center.x+c.offset.translate.x,y:c.attrs.center.y+c.offset.translate.y},m=c.attrs.rotate-c.offset.rotate,q={x:c.attrs.scale.x/c.offset.scale.x,y:c.attrs.scale.y/c.offset.scale.y},p={x:c.attrs.translate.x-c.offset.translate.x,y:c.attrs.translate.y-c.offset.translate.y};
if(c.opts.animate){f(["animate start"]);o.el.animate({transform:["R",m,l.x,l.y,"S",q.x,q.y,l.x,l.y,"T",p.x,p.y]+c.items[n].transformString},c.opts.animate.delay,c.opts.animate.easing,function(){f(["animate end"]);
c.updateHandles()})}else{o.el.transform(["R",m,l.x,l.y,"S",q.x,q.y,l.x,l.y,"T",p.x,p.y]+c.items[n].transformString);f(["apply"]);c.updateHandles()}})};c.unplug=function(){var l=c.attrs;c.hideHandles();
delete e.freeTransform;return l};(e.type==="set"?e.items:[e]).map(function(l){c.items.push({el:l,attrs:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},transformString:l.matrix.toTransformString()})});c.items.map(function(m,l){if(m.el._&&m.el._.transform){m.el._.transform.map(function(n){if(n[0]){switch(n[0].toUpperCase()){case"T":c.items[l].attrs.translate.x+=n[1];
c.items[l].attrs.translate.y+=n[2];break;case"S":c.items[l].attrs.scale.x*=n[1];c.items[l].attrs.scale.y*=n[2];break;case"R":c.items[l].attrs.rotate+=n[1];break}}})}});if(e.type!=="set"){c.attrs.rotate=c.items[0].attrs.rotate;
c.attrs.scale=c.items[0].attrs.scale;c.attrs.translate=c.items[0].attrs.translate;c.items[0].attrs={rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}};c.items[0].transformString=""}function j(){var m={x:(c.attrs.rotate)*Math.PI/180,y:(c.attrs.rotate+90)*Math.PI/180};
var l={x:c.attrs.size.x/2*c.attrs.scale.x,y:c.attrs.size.y/2*c.attrs.scale.y};var o=[],n=[{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}];n.map(function(p){o.push({x:(c.attrs.center.x+c.attrs.translate.x+p.x*l.x*Math.cos(m.x))+p.y*l.y*Math.cos(m.y),y:(c.attrs.center.y+c.attrs.translate.y+p.x*l.x*Math.sin(m.x))+p.y*l.y*Math.sin(m.y)})
});return o}function d(q){if(q&&c.opts.snap.drag){var n=q.x,r=q.y,p={x:0,y:0},m={x:0,y:0};[0,1].map(function(){p.x=n-Math.round(n/c.opts.snap.drag)*c.opts.snap.drag;p.y=r-Math.round(r/c.opts.snap.drag)*c.opts.snap.drag;
if(Math.abs(p.x)<=c.opts.snapDist.drag){m.x=p.x}if(Math.abs(p.y)<=c.opts.snapDist.drag){m.y=p.y}n+=q.width-m.x;r+=q.height-m.y});c.attrs.translate.x-=m.x;c.attrs.translate.y-=m.y}if(c.opts.boundary){var l=c.opts.boundary;
if(c.attrs.center.x+c.attrs.translate.x<l.x){c.attrs.translate.x+=l.x-(c.attrs.center.x+c.attrs.translate.x)}if(c.attrs.center.y+c.attrs.translate.y<l.y){c.attrs.translate.y+=l.y-(c.attrs.center.y+c.attrs.translate.y)
}if(c.attrs.center.x+c.attrs.translate.x>l.x+l.width){c.attrs.translate.x+=l.x+l.width-(c.attrs.center.x+c.attrs.translate.x)}if(c.attrs.center.y+c.attrs.translate.y>l.y+l.height){c.attrs.translate.y+=l.y+l.height-(c.attrs.center.y+c.attrs.translate.y)
}}if(c.opts.keepRatio){c.attrs.scale.x=c.attrs.scale.y}p=Math.abs(c.attrs.rotate%c.opts.snap.rotate);p=Math.min(p,c.opts.snap.rotate-p);if(p<c.opts.snapDist.rotate){c.attrs.rotate=Math.round(c.attrs.rotate/c.opts.snap.rotate)*c.opts.snap.rotate
}p={x:Math.abs((c.attrs.scale.x*c.attrs.size.x)%c.opts.snap.scale),y:Math.abs((c.attrs.scale.y*c.attrs.size.x)%c.opts.snap.scale)};p={x:Math.min(p.x,c.opts.snap.scale-p.x),y:Math.min(p.y,c.opts.snap.scale-p.y)};
if(p.x<c.opts.snapDist.scale){c.attrs.scale.x=Math.round(c.attrs.scale.x*c.attrs.size.x/c.opts.snap.scale)*c.opts.snap.scale/c.attrs.size.x}if(p.y<c.opts.snapDist.scale){c.attrs.scale.y=Math.round(c.attrs.scale.y*c.attrs.size.y/c.opts.snap.scale)*c.opts.snap.scale/c.attrs.size.y
}if(c.opts.range.rotate){var o=(360+c.attrs.rotate)%360;if(o>180){o-=360}if(o<c.opts.range.rotate[0]){c.attrs.rotate+=c.opts.range.rotate[0]-o}if(o>c.opts.range.rotate[1]){c.attrs.rotate+=c.opts.range.rotate[1]-o
}}if(c.opts.range.scale){if(c.attrs.scale.x*c.attrs.size.x<c.opts.range.scale[0]){c.attrs.scale.x=c.opts.range.scale[0]/c.attrs.size.x}if(c.attrs.scale.y*c.attrs.size.y<c.opts.range.scale[0]){c.attrs.scale.y=c.opts.range.scale[0]/c.attrs.size.y
}if(c.attrs.scale.x*c.attrs.size.x>c.opts.range.scale[1]){c.attrs.scale.x=c.opts.range.scale[1]/c.attrs.size.x}if(c.attrs.scale.y*c.attrs.size.y>c.opts.range.scale[1]){c.attrs.scale.y=c.opts.range.scale[1]/c.attrs.size.y
}}}function b(m){var l,n={};for(l in m){n[l]=typeof m[l]==="object"?b(m[l]):m[l]}return n}var g=false;function f(m){if(c.callback){var l=[];m.map(function(o,n){if(o){l.push(o)}});clearTimeout(g);setTimeout(function(){if(c.callback){c.callback(c,l)
}},1)}}c.updateHandles();return c};